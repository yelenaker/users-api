trigger:
  branches:
    include:
      - main
      - feature/*

pool:
  name: Default

variables:
  system.debug: true
  group: docker-settings(users-api)
  FORCE_VERSION: ''
  DOCKER_REPOSITORY: "qwqwqwrwe/users-api"
  TEMPLATES_DIR: $(Build.SourcesDirectory)/templates
  HELM_REPOSITORY: "oci://docker.io/qwqwqwrwe/users-api"

resources:
  repositories:
    - repository: templates
      type: git
      name: ReadingTracker/ci-templates
      ref: refs/heads/main

# --------------------- PRE BUILD ---------------------
stages:
  - stage: Pre_Build
    jobs:
      - job: Pre_Build_Analysis
        steps:
          - checkout: self
          - checkout: templates
            path: templates

          - script: |
              echo "##vso[task.setvariable variable=TEMPLATES_DIR]$(Build.SourcesDirectory)/templates"
            displayName: "Set TEMPLATES_DIR Variable"

          - script: |
              echo "== Azure DevOps Variables =="
              echo "Agent.TempDirectory: $(Agent.TempDirectory)"
              echo "Build.SourceBranch: $(Build.SourceBranch)"
              echo "Build.Repository.Name: $(Build.Repository.Name)"
              echo "DOCKER_REPOSITORY: $(DOCKER_REPOSITORY)"
              echo "APP_VERSION: $(APP_VERSION)"
            displayName: "Print Azure DevOps Variables"

          - bash: |
              if ! command -v jq &> /dev/null; then
                echo "jq not found, installing..."
                sudo apt-get update && sudo apt-get install -y jq
              else
                echo "jq is already installed"
              fi
            displayName: "Install jq if not installed"

          - bash: |
              echo "== Listing root files in Build.SourcesDirectory =="
              ls -alh $(Build.SourcesDirectory)
            displayName: "List Files in Repository"

          - bash: |
              echo "== Searching for dockerhub.sh =="
              find $(Build.SourcesDirectory) -name "dockerhub.sh"
            displayName: "üîç Search dockerhub.sh in Build.SourcesDirectory"

          # –ó–ê–î–ê–ß–ê 4: –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –≤–µ—Ä—Å—ñ—ó
          - bash: |
              echo "Resolved path: $(TEMPLATES_DIR)/common-scripts"
              if [ -f "$(TEMPLATES_DIR)/common-scripts/dockerhub.sh" ]; then
                echo "‚úÖ dockerhub.sh found"
                VERSION=$(bash "$(TEMPLATES_DIR)/common-scripts/dockerhub.sh" $(DOCKER_USERNAME) $(DOCKER_REPOSITORY))
                echo "Script returned version: $VERSION"
                echo "##vso[task.setvariable variable=APP_VERSION_FROM_SCRIPT;isOutput=true]$VERSION"
              else
                echo "‚ùå dockerhub.sh not found"
              fi
            displayName: "Check if dockerhub.sh exists and execute"
            condition: and(succeeded(), eq(variables['FORCE_VERSION'], ''))
            name: set_app_version

# --------------------- BUILD & TEST ---------------------
  - stage: Project_Build_and_Test
    dependsOn: Pre_Build
    condition: succeeded()
    jobs:
      - job: Build_And_Test
        steps:
          - script: |
              echo "Running unit tests..."
              pytest tests/
            displayName: "Run Unit Tests"

          # –ó–ê–î–ê–ß–ê 6: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –ø—ñ—Å–ª—è –∑–±—ñ—Ä–∫–∏
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: "Publish Build Artifacts"

# --------------------- DOCKER BUILD & PUSH ---------------------
  - stage: Docker_Build_and_Push
    dependsOn: Project_Build_and_Test
    condition: succeeded()
    variables:
      APP_VERSION: $[ stageDependencies.Pre_Build.Pre_Build_Analysis.outputs['set_app_version.APP_VERSION_FROM_SCRIPT'] ]
    jobs:
      - job: Build_and_Push
        steps:
          - task: Docker@2
            displayName: "Build Docker Image"
            inputs:
              command: build
              repository: $(DOCKER_REPOSITORY)
              dockerfile: Dockerfile
              containerRegistry: dockerhub-service-connection
              tags: |
                $(APP_VERSION)
            env:
              DOCKER_REPOSITORY: $(DOCKER_REPOSITORY)
              APP_VERSION: $(APP_VERSION)

          - task: Docker@2
            displayName: "Push Docker Image"
            condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
            inputs:
              command: push
              repository: $(DOCKER_REPOSITORY)
              containerRegistry: dockerhub-service-connection
              tags: |
                $(APP_VERSION)
            env:
              DOCKER_REPOSITORY: $(DOCKER_REPOSITORY)
              APP_VERSION: $(APP_VERSION)

          # –ó–ê–î–ê–ß–ê 8: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è Docker-–æ–±—Ä–∞–∑—É —è–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: 'docker_image'
              publishLocation: 'Container'
            displayName: "Publish Docker Image Artifact"

# --------------------- HELM CHART ---------------------
  - stage: Helm_Chart_Pack_and_Push
    dependsOn: Docker_Build_and_Push
    condition: succeeded()
    jobs:
      - job: Pack_and_Push
        steps:
          - script: |
              echo "Pack and Push Helm Chart"
              helm package ./helm && helm push ./users-api-*.tgz $(HELM_REPOSITORY)
            displayName: "Helm Packaging"

# --------------------- POST BUILD ---------------------
  - stage: Post_Build
    dependsOn: Helm_Chart_Pack_and_Push
    condition: succeeded()
    jobs:
      - job: Post_Build
        steps:
          - script: |
              echo "DOCKER_REPOSITORY: $(DOCKER_REPOSITORY)"
              echo "APP_VERSION: $(APP_VERSION)"
            displayName: "Print Final Info"
